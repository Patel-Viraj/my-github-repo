name: Upload Website

on:
  push:
    branches:
    - deploy

jobs:
  deploy:
    runs-on: self-hosted
    #env:
    #   AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #   AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    steps:
    - uses: actions/checkout@main

    - name: Take backup 
      run: |
       ssh -t ubuntu@35.174.116.224 " 'cp' -fR /home/ubuntu/node-app/* /home/ubuntu/backup/ "
       echo "file Updated"

    - name: copy to Deploy server 
      run: |
       rsync -zhvr . ubuntu@35.174.116.224:/home/ubuntu/node-app/
       echo "file Updated"
      
    - name: Install Packages
      run: |
       ssh -t ubuntu@35.174.116.224 'cd /home/ubuntu/node-app && npm i'
       echo "Packages Installed"

    - name: Start Application
      run: |
       ssh -t ubuntu@35.174.116.224 'cd /home/ubuntu/node-app && pm2 restart app'
       echo "Application is Live"   
        
